<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2D UMAP Embedding Viewer</title>

<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/themes/adaptive.js"></script>

<!-- UMAP -->
<script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--highcharts-background-color, #fff);
  color: var(--highcharts-neutral-color-100, #000);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  overflow: hidden;
}

.highcharts-figure {
  display: block;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

#container {
  width: 100%;
  height: 600px;
}
</style>
</head>
<body>

<figure class="highcharts-figure">
  <div id="container"></div>
</figure>

<script>
(async function() {

  // --- UTF-8 safe Base64URL → JSON decoder ---
  function decodeBase64Url(str) {
    if (!str) return null;
    try {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4;
      if (pad) str += '='.repeat(4 - pad);
      const binary = atob(str);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const jsonText = new TextDecoder().decode(bytes);
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("Decode error:", e);
      return null;
    }
  }

  // --- Read ?spec= param ---
  const params = new URLSearchParams(window.location.search);
  const specParam = params.get('spec');
  const payload = decodeBase64Url(specParam);

  if (!payload || !Array.isArray(payload.embeddings)) {
    Highcharts.chart('container', {
      title: { text: 'No embeddings provided' },
      series: [{ data: [] }]
    });
    return;
  }

  // --- Run UMAP client-side ---
  const umap = new UMAP.UMAP({ nComponents: 2, nNeighbors: 15, minDist: 0.1 });
const reduced = umap.fit(payload.embeddings);

  // --- Normalize 0–10 range ---
  const flatVals = reduced.flat();
  const minVal = Math.min(...flatVals);
  const maxVal = Math.max(...flatVals);
  const range = (maxVal - minVal) || 1;

  const scaledPoints = reduced.map(([x, y]) => [
    ((x - minVal) / range) * 10,
    ((y - minVal) / range) * 10
  ]);

  // --- Build scatter data ---
  const scatterData = scaledPoints.map((p, i) => ({
    x: p[0],
    y: p[1],
    name: payload.labels?.[i] || `Point ${i + 1}`,
    color: payload.colors?.[i] || undefined
  }));

  // --- Render chart ---
  Highcharts.chart('container', {
    chart: {
      type: 'scatter',
      zooming: { type: 'xy' }
    },
    title: { text: payload.title || '2D UMAP Embedding Projection' },
    subtitle: { text: payload.subtitle || 'Computed client-side with UMAP.js' },
    xAxis: {
      title: { text: 'UMAP-1' },
      gridLineWidth: 1
    },
    yAxis: {
      title: { text: 'UMAP-2' },
      gridLineWidth: 1
    },
    legend: { enabled: false },
    tooltip: {
      useHTML: true,
      headerFormat: '',
      pointFormat: '<b>{point.name}</b>'
    },
    plotOptions: {
      scatter: {
        marker: {
          radius: 3,
          symbol: 'circle',
          fillOpacity: 0.6,
          states: {
            hover: { enabled: true, lineColor: 'rgb(100,100,100)', fillOpacity: 1 }
          }
        },
        jitter: { x: 0.01, y: 0.01 }
      }
    },
    series: [{
      name: 'Embeddings',
      colorByPoint: true,
      data: scatterData
    }]
  });

})();
</script>
</body>
</html>
