<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2D Embedding Visualizer</title>

<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<!-- LZ-String for decompression -->
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
<!-- UMAP.js -->
<script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--highcharts-background-color, #fff);
  color: var(--highcharts-neutral-color-100, #000);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.highcharts-figure {
  min-width: 300px;
  max-width: 900px;
  margin: 0 auto;
  padding: 0;
}

#container {
  width: 100%;
  height: 600px;
}
</style>
</head>
<body>

<figure class="highcharts-figure">
  <div id="container"></div>
</figure>

<script>
(async function() {

  // --- Decode payload from ?spec= using LZ-String ---
  function decodePayload(str) {
    if (!str) return null;
    try {
      const jsonText = LZString.decompressFromEncodedURIComponent(str);
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("❌ Decompression error:", e);
      return null;
    }
  }

  // --- Get ?spec= parameter ---
  const params = new URLSearchParams(window.location.search);
  const specParam = params.get('spec');
  const payload = decodePayload(specParam);

  if (!payload || !payload.embeddings) {
    Highcharts.chart('container', {
      title: { text: '⚠️ No valid data received' },
      series: [{ data: [] }]
    });
    return;
  }

  // --- UMAP Projection (N-D → 2D) ---
  const umap = new UMAP.UMAP({ nComponents: 2, nNeighbors: 15, minDist: 0.1 });
  let reduced;
  try {
    // In iframe: use sync (fit); outside: async (fitAsync)
    const inIframe = window.self !== window.top;
    reduced = inIframe ? umap.fit(payload.embeddings)
                       : await umap.fitAsync(payload.embeddings);
  } catch (err) {
    console.warn("UMAP async failed, falling back to sync mode:", err);
    reduced = umap.fit(payload.embeddings);
  }

  // --- Group points by brand (color) ---
  const labels = payload.labels || [];
  const colors = payload.colors || [];
  const seriesMap = {};

  reduced.forEach((point, i) => {
    const brand = labels[i] || "unknown";
    const color = colors[i] || "#888";
    if (!seriesMap[brand]) {
      seriesMap[brand] = { name: brand, color, data: [] };
    }
    seriesMap[brand].data.push({
      x: point[0],
      y: point[1],
      name: brand
    });
  });

  const series = Object.values(seriesMap);

  // --- Render chart ---
  Highcharts.chart('container', {
    chart: {
      type: 'scatter',
      zooming: { type: 'xy' }
    },
    title: {
      text: payload.title || '2D Embedding Projection'
    },
    subtitle: {
      text: payload.subtitle || 'Reduced to 2D with UMAP'
    },
    xAxis: { title: { text: 'UMAP-1' } },
    yAxis: { title: { text: 'UMAP-2' } },
    legend: { enabled: true },
    plotOptions: {
      scatter: {
        marker: {
          radius: 3,
          symbol: 'circle',
          states: {
            hover: { enabled: true, lineColor: 'rgb(100,100,100)' }
          }
        },
        states: {
          hover: { marker: { enabled: false } }
        },
        jitter: { x: 0.005, y: 0.005 }
      }
    },
    tooltip: {
      useHTML: true,
      headerFormat: '',
      pointFormat: '<b>{point.name}</b><br>UMAP-1: {point.x:.2f}<br>UMAP-2: {point.y:.2f}'
    },
    series
  });

})();
</script>
</body>
</html>
