<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inline Chart</title>

<!-- Highcharts core first -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/themes/adaptive.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--highcharts-background-color, #fff);
  color: var(--highcharts-neutral-color-100, #000);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.highcharts-figure {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#container {
  width: 100%;
  height: auto;
  min-height: 350px;
}

.highcharts-description {
  display: none !important;
}

/* hide the Highcharts context menu */
.highcharts-contextbutton, .highcharts-menu {
  display: none !important;
}

/* ensure legend sits centered below the chart */
.highcharts-legend {
  text-align: center !important;
  justify-content: center !important;
  margin-top: 8px !important;
}
</style>
</head>
<body>

<figure class="highcharts-figure">
  <div id="container"></div>
  <p id="description" class="highcharts-description"></p>
</figure>

<script>
(function() {
  // --- UTF-8 safe Base64URL â†’ JSON decoder ---
  function decodeBase64Url(str) {
    if (!str) return null;
    try {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4;
      if (pad) str += '='.repeat(4 - pad);
      const binary = atob(str);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const jsonText = new TextDecoder().decode(bytes);
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("Decode error:", e);
      return null;
    }
  }

  // --- Get ?spec= param from URL ---
  const params = new URLSearchParams(window.location.search);
  const specParam = params.get('spec');
  const data = decodeBase64Url(specParam);

  // --- Fallback ---
  if (!data) {
    Highcharts.chart('container', {
      title: { text: 'No chart data provided' },
      series: [{ data: [1, 2, 3] }]
    });
    return;
  }

  try {
    const chartOptions = data.chart || data;

    // ðŸ”¹ Force hide export / menu buttons
    chartOptions.exporting = { enabled: false };

    // ðŸ”¹ Force legend layout below chart (no overrides possible)
    chartOptions.legend = Object.assign({
      align: 'center',
      verticalAlign: 'bottom',
      layout: 'horizontal',
      floating: false,
      itemStyle: { fontSize: '12px' },
      itemMarginTop: 4,
      itemMarginBottom: 4
    }, chartOptions.legend || {});

    // ðŸ”¹ Create chart
    const chart = Highcharts.chart('container', chartOptions);

    // ðŸ”¹ Reposition legend manually (for polar, radar, etc.)
    chart.update({
      legend: {
        align: 'center',
        verticalAlign: 'bottom',
        layout: 'horizontal',
        x: 0,
        y: 10
      }
    }, false);
    chart.redraw();
  } catch (err) {
    console.error('Chart render error:', err);
  }

  // --- Optional description ---
  const descEl = document.getElementById('description');
  if (data.description && data.description.trim()) {
    descEl.style.display = "block";
    descEl.innerText = data.description;
  }

  // --- Auto-resize for Glide ---
  function notifyParentHeight() {
    const height = document.getElementById('container').offsetHeight + 8;
    window.parent?.postMessage({ type: "resize", height }, "*");
  }
  notifyParentHeight();
  setTimeout(notifyParentHeight, 400);
  window.addEventListener("resize", notifyParentHeight);
  Highcharts.addEvent(Highcharts.Chart, 'redraw', notifyParentHeight);
})();
</script>
</body>
</html>
