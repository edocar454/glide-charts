<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inline Chart</title>

<!-- Highcharts + modules -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/themes/adaptive.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
    "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
  background: var(--highcharts-background-color);
  color: var(--highcharts-neutral-color-100);
  margin: 0;
  padding: 0;
}
.highcharts-figure {
  min-width: 310px;
  max-width: 800px;
  margin: 1em auto;
}
#container {
  height: 400px;
}
.highcharts-description {
  margin: 0.3rem 10px;
  text-align: center;
  font-size: 0.9rem;
  color: var(--highcharts-neutral-color-60, #666);
}
</style>
</head>
<body>

<figure class="highcharts-figure">
  <div id="container"></div>
  <p id="description" class="highcharts-description"></p>
</figure>

<script>
(function() {
  // --- Base64URL -> JSON decoder (UTF-8 safe)
  function decodeBase64Url(str) {
    if (!str) return null;
    try {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4;
      if (pad) str += '='.repeat(4 - pad);
      const binary = atob(str);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const jsonText = new TextDecoder().decode(bytes);
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("Decode error:", e);
      return null;
    }
  }

  // --- Get ?spec= param
  const params = new URLSearchParams(window.location.search);
  const specParam = params.get('spec');
  const data = decodeBase64Url(specParam);

  if (!data) {
    document.getElementById('description').innerText = 'No chart data received.';
    return;
  }

  // --- Render Highcharts chart
  try {
    Highcharts.chart('container', data.chart || data);
  } catch (err) {
    console.error('Chart render error:', err);
  }

  // --- Render optional AI recommendation text
  const descEl = document.getElementById('description');
  if (data.description) {
    descEl.innerText = data.description;
  } else {
    descEl.innerText = ''; // nothing if not provided
  }
})();
</script>
</body>
</html>
