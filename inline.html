<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inline Chart</title>

<!-- Highcharts + modules -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/themes/adaptive.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--highcharts-background-color, #fff);
  color: var(--highcharts-neutral-color-100, #000);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.highcharts-figure {
  min-width: 310px;
  max-width: 800px;
  margin: 0 auto;
  padding: 0;
}

#container {
  width: 100%;
  height: 100%;
  min-height: 350px; /* fallback */
}

.highcharts-description {
  margin: 0;
  padding: 0;
  text-align: center;
  font-size: 0.9rem;
  color: var(--highcharts-neutral-color-60, #666);
  display: none; /* hidden by default */
}
</style>
</head>
<body>

<figure class="highcharts-figure">
  <div id="container"></div>
  <p id="description" class="highcharts-description"></p>
</figure>

<script>
(function() {
  // --- UTF-8 safe Base64URL â†’ JSON decoder ---
  function decodeBase64Url(str) {
    if (!str) return null;
    try {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4;
      if (pad) str += '='.repeat(4 - pad);
      const binary = atob(str);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const jsonText = new TextDecoder().decode(bytes);
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("Decode error:", e);
      return null;
    }
  }

  // --- Get ?spec= param from URL ---
  const params = new URLSearchParams(window.location.search);
  const specParam = params.get('spec');
  const data = decodeBase64Url(specParam);

  // --- If no data, show placeholder ---
  if (!data) {
    Highcharts.chart('container', {
      title: { text: 'No chart data provided' },
      series: [{ data: [1, 2, 3] }]
    });
    document.getElementById('description').style.display = "none";
    return;
  }

  // --- Render the chart ---
  try {
    Highcharts.chart('container', data.chart || data);
  } catch (err) {
    console.error('Chart render error:', err);
  }

  // --- Show description only if provided ---
  const descEl = document.getElementById('description');
  if (data.description && data.description.trim()) {
    descEl.style.display = "block";
    descEl.innerText = data.description;
  } else {
    descEl.style.display = "none";
  }

  // --- Notify parent frame (Glide) to resize correctly ---
  window.parent?.postMessage({ type: "resize", height: document.body.scrollHeight }, "*");
})();
</script>
</body>
</html>
