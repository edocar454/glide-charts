<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D Embedding Viewer</title>

<!-- Highcharts + 3D modules -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-3d.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: auto;
  background: var(--highcharts-background-color, #fff);
  color: var(--highcharts-neutral-color-100, #000);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  overflow: hidden;
}

.highcharts-figure {
  display: block;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

#container {
  width: 100%;
  height: 600px;
}
</style>
</head>
<body>

<figure class="highcharts-figure">
  <div id="container"></div>
</figure>

<script>
(function() {

  // --- Base64URL â†’ JSON decoder ---
  function decodeBase64Url(str) {
    if (!str) return null;
    try {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4;
      if (pad) str += '='.repeat(4 - pad);
      const binary = atob(str);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const jsonText = new TextDecoder().decode(bytes);
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("Decode error:", e);
      return null;
    }
  }

  // --- Read ?spec= param ---
  const params = new URLSearchParams(window.location.search);
  const specParam = params.get('spec');
  const payload = decodeBase64Url(specParam);

  // --- Extract data ---
  let seriesData = payload?.points || [[1, 2, 3]];
  if (Array.isArray(seriesData[0]) && Array.isArray(seriesData[0][0])) {
    seriesData = seriesData.flat();
  }

  const labels = payload?.labels || [];
  const titleText = payload?.title || "3D Embedding Space";
  const subtitleText = payload?.subtitle || "Click and drag to rotate";

  console.log("Loaded points:", seriesData.length);
  console.log("Loaded labels:", labels.length);

  // --- Give points a 3D gradient look ---
  Highcharts.setOptions({
    colors: Highcharts.getOptions().colors.map(color => ({
      radialGradient: { cx: 0.4, cy: 0.3, r: 0.5 },
      stops: [
        [0, color],
        [1, Highcharts.color(color).brighten(-0.2).get('rgb')]
      ]
    }))
  });

  // --- Create chart ---
  const chart = new Highcharts.Chart({
    chart: {
      renderTo: 'container',
      margin: 100,
      type: 'scatter3d',
      animation: false,
      options3d: {
        enabled: true,
        alpha: 10,
        beta: 30,
        depth: 250,
        viewDistance: 5,
        fitToPlot: false,
        frame: {
          bottom: { size: 1, color: 'rgba(0,0,0,0.02)' },
          back: { size: 1, color: 'rgba(0,0,0,0.04)' },
          side: { size: 1, color: 'rgba(0,0,0,0.06)' }
        }
      }
    },
    title: { text: titleText },
    subtitle: { text: subtitleText },
    legend: { enabled: false },
    xAxis: { gridLineWidth: 1 },
    yAxis: { min: 0, max: 10, title: null },
    zAxis: { min: 0, max: 10 },
    tooltip: {
      useHTML: true,
      pointFormatter: function () {
        return `<b>${this.name}</b><br>
                X: ${this.x.toFixed(2)}<br>
                Y: ${this.y.toFixed(2)}<br>
                Z: ${this.z.toFixed(2)}`;
      }
    },
    plotOptions: {
      scatter: {
        width: 10,
        height: 10,
        depth: 10
      }
    },
    series: [{
      name: 'Embeddings',
      colorByPoint: true,
      data: seriesData.map((p, i) => ({
        x: p[0],
        y: p[1],
        z: p[2],
        name: labels[i] || `Point ${i + 1}`
      }))
    }]
  });

  // --- Enable 3D rotation ---
  (function(H) {
    function dragStart(eStart) {
      eStart = chart.pointer.normalize(eStart);
      const posX = eStart.chartX,
            posY = eStart.chartY,
            alpha = chart.options.chart.options3d.alpha,
            beta = chart.options.chart.options3d.beta,
            sensitivity = 5;
      const handlers = [];

      function drag(e) {
        e = chart.pointer.normalize(e);
        chart.update({
          chart: {
            options3d: {
              alpha: alpha + (e.chartY - posY) / sensitivity,
              beta: beta + (posX - e.chartX) / sensitivity
            }
          }
        }, undefined, undefined, false);
      }

      function unbindAll() {
        handlers.forEach(unbind => unbind && unbind());
        handlers.length = 0;
      }

      handlers.push(H.addEvent(document, 'mousemove', drag));
      handlers.push(H.addEvent(document, 'touchmove', drag));
      handlers.push(H.addEvent(document, 'mouseup', unbindAll));
      handlers.push(H.addEvent(document, 'touchend', unbindAll));
    }
    H.addEvent(chart.container, 'mousedown', dragStart);
    H.addEvent(chart.container, 'touchstart', dragStart);
  }(Highcharts));

})();
</script>
</body>
</html>
